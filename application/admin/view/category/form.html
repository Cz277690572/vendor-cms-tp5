<form onsubmit="return false;" action="{:request()->url()}" data-auto="true" method="post" class='layui-form layui-card'
      autocomplete="off">

    <div class="layui-card-body">

        <div class="layui-row margin-bottom-15">
            <label class="layui-col-xs2 think-form-label">分类名称</label>
            <label class="layui-col-xs10">
                <input name="name" required value='{$vo.name|default=""}' placeholder="请输入分类名称" class="layui-input">
            </label>
        </div>

        <div class="layui-row margin-bottom-15">
            <label class="layui-col-xs2 think-form-label">排序</label>
            <label class="layui-col-xs10">
                <input name="name" required value='{$vo.sort|default=""}' placeholder="请输入分类排序" class="layui-input">
            </label>
        </div>

        <div class="layui-row margin-bottom-15">
            <label class="layui-col-xs2 think-form-label">是否上线</label>
            <label class="layui-col-xs10">
                <label class="think-radio">
                    <!--{if(isset($vo.status) and ($vo.status eq '0'))}-->
                    <input type="radio" name="status" value="1"> 上线
                    <input type="radio" checked name="status" value="0"> 下线
                    <!--{else}-->
                    <input type="radio" checked name="status" value="1"> 上线
                    <input type="radio" name="status" value="0"> 下线
                    <!--{/if}-->
                </label>
            </label>
        </div>

<!--        <div class="layui-row margin-bottom-15">-->
<!--            <label class="layui-col-xs2 think-form-label">分类图片</label>-->
<!--            <label class="layui-col-xs8 think-form-group-left">-->
<!--                <input name="logo" required value='{$vo.url|default=""}' placeholder="请上传分类图片" class="layui-input">-->
<!--            </label>-->
<!--            <a class="layui-col-xs2 layui-btn think-form-group-right" data-file="btn" data-field="logo"-->
<!--               data-type="png,jpg,gif">-->
<!--                <i class="layui-icon layui-icon-upload"></i> 上传图片-->
<!--            </a>-->
<!--        </div>-->
        <div class="layui-form-item label-required-prev">
            <span class="color-green">分类图片</span>
            <div class="layui-clear">
                <div class="upload-image-box pull-left transition" data-tips-image="{{$vo.topic_img_url}}" style="{{item.style}}">
                    <input ng-model="$vo.topic_img_url" data-auto-none value="{{$vo.topic_img_url}}" type="hidden" name="local_url">
                </div>
                <div class="pull-left padding-top-15 padding-left-15">
                    <button type="button" data-title="上传图片" data-file="btn" data-type="jpg,png,jpeg" data-field="local_url" class="layui-btn layui-btn-sm layui-btn-primary">上传图片</button>
                    <br>
                    <label class="think-checkbox notselect margin-top-15">
                        <input ng-model="$vo.topic_img_url" ng-checked="!!$vo.topic_img_url" data-auto-none type="checkbox" value="1" name="topic_img_url"> 在正文顶部显示此图片
                    </label>
                </div>
            </div>
            <p class="color-desc">封面大图片建议尺寸 900像素 * 500像素</p>
        </div>


        <div class="layui-row margin-bottom-15">
            <label class="layui-col-xs2 think-form-label">商品分类描述</label>
            <label class="layui-col-xs10">
                <textarea class="layui-textarea" name="description">{$vo.description|default=''}</textarea>
            </label>
        </div>
    </div>

    <div class="hr-line-dashed"></div>
    <div class="layui-form-item text-center">
        {notempty name='vo.id'}<input type='hidden' value='{$vo.id}' name='id'>{/notempty}
        <button class="layui-btn" type='submit'>保存数据</button>
        <button class="layui-btn layui-btn-danger" type='button' data-confirm="确定要取消编辑吗？" data-close>取消编辑</button>
    </div>
</form>

{block name='script'}
<script>
    require(['angular', 'ckeditor'], function () {

        var editor;
        var $form = $('form[name="news"]');
        var $vali = $form.vali().data('validate');

        var app = angular.module("NewsEditor", []).run(callback);
        angular.bootstrap(document.getElementById(app.name), [app.name]);

        function callback($rootScope) {
            $rootScope.list = [];
            $rootScope.item = {};

            $.form.load('{:request()->url()}', {output: 'json'}, 'get', function (ret) {
                return $rootScope.$apply(function () {
                    apply((ret.data || {articles: []}).articles || []);
                }), false;
            });

            function apply(list) {
                if (list.length < 1) list.push({
                    title: '新建图文', author: '管理员', content: '文章内容',
                    read_num: 0, local_url: '__ROOT__/static/theme/img/image.png',
                });
                for (var i in list) {
                    list[i].active = false;
                    list[i].style = "background-image:url('" + list[i].local_url + "')";
                }
                $rootScope.list = list;
                $rootScope.item = $rootScope.list[0];
                $rootScope.setItemValue('active', true);
                $('.layui-card-body.layui-hide').removeClass('layui-hide');
                setTimeout(function () {
                    if (editor) editor.destroy();
                    editor = window.createEditor('[name="content"]');
                    editor.setData($rootScope.item.content);
                    $vali.checkAllInput();
                }, 100);
            }

            $rootScope.upItem = function (index, $event) {
                $event.stopPropagation();
                var tmp = [], cur = $rootScope.list[index];
                if (index < 1) return false;
                for (var i in $rootScope.list) {
                    (parseInt(i) === parseInt(index) - 1) && tmp.push(cur);
                    (parseInt(i) !== parseInt(index)) && tmp.push($rootScope.list[i]);
                }
                apply(tmp);
            };
            $rootScope.dnItem = function (index, $event) {
                $event.stopPropagation();
                var tmp = [], cur = $rootScope.list[index];
                if (index > $rootScope.list.length - 2) return false;
                for (var i in $rootScope.list) {
                    (parseInt(i) !== parseInt(index)) && tmp.push($rootScope.list[i]);
                    (parseInt(i) === parseInt(index) + 1) && tmp.push(cur);
                }
                apply(tmp);
            };
            $rootScope.delItem = function (index, $event) {
                $event.stopPropagation();
                var list = $rootScope.list, temp = [];
                for (var i in list) (parseInt(i) !== parseInt(index)) && temp.push(list[i]);
                apply(temp);
            };
            $rootScope.setItem = function (index, $event) {
                $event.stopPropagation();
                $vali.checkAllInput();
                if ($form.find('.validate-error').size() > 0) return 0;
                if (editor.getData().length < 1) {
                    return $.msg.tips('文章内容不能为空，请输入文章内容！');
                }
                for (var i in $rootScope.list) if (parseInt(i) !== parseInt(index)) {
                    $rootScope.list[i].active = false;
                } else {
                    $rootScope.item.content = editor.getData();
                    $rootScope.item = $rootScope.list[i];
                    editor.setData($rootScope.item.content);
                    $rootScope.setItemValue('active', true);
                }
            };
            $rootScope.setItemValue = function (name, value) {
                $rootScope.item[name] = value;
                $rootScope.item.style = "background-image:url('" + $rootScope.item.local_url + "')";
            };
            $rootScope.addItem = function () {
                if ($rootScope.list.length > 7) {
                    return $.msg.tips('最多允许增加7篇文章哦！');
                }
                $rootScope.list.push({
                    title: '新建图文',
                    author: '管理员',
                    content: '文章内容',
                    read_num: 0,
                    local_url: '__ROOT__/static/theme/img/image.png',
                    style: "background-image:url('__ROOT__/static/theme/img/image.png')"
                });
            };
            $rootScope.submit = function () {
                $vali.checkAllInput();
                if ($form.find('.validate-error').size() > 0) {
                    return $.msg.tips('表单验证不成功，请输入需要的内容！');
                }
                $rootScope.item.content = editor.getData();
                var data = [];
                for (var i in $rootScope.list) data.push({
                    id: $rootScope.list[i].id,
                    title: $rootScope.list[i].title,
                    author: $rootScope.list[i].author,
                    digest: $rootScope.list[i].digest,
                    content: $rootScope.list[i].content,
                    read_num: $rootScope.list[i].read_num,
                    local_url: $rootScope.list[i].local_url,
                    topic_img_url: $rootScope.list[i].topic_img_url ? 1 : 0,
                    content_source_url: $rootScope.list[i].content_source_url,
                });
                $.form.load('{:request()->url()}', {data: data}, "post");
            };
            $('[name="local_url"]').on('change', function (value) {
                value = this.value;
                $rootScope.$apply(function () {
                    $rootScope.setItemValue('local_url', value);
                });
            });
        }
    });
</script>
{/block}